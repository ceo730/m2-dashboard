<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M2 ì‹¤ì‹œê°„ ì»¨ì„¤íŒ… ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI','Malgun Gothic',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
a{color:#38bdf8}
.header{background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border-bottom:1px solid #1e293b;padding:1.25rem 2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
.header h1{font-size:1.5rem;font-weight:700;color:#f1f5f9;letter-spacing:-0.02em}
.header h1 span{color:#38bdf8}
.controls{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.controls label{font-size:.8rem;color:#94a3b8}
.controls select,.controls button{background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:.5rem;padding:.45rem .9rem;font-size:.8rem;cursor:pointer;transition:all .15s}
.controls select:hover,.controls button:hover{border-color:#38bdf8;background:#1e3a5f}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:.4rem}
.status-dot.ok{background:#4ade80}
.status-dot.err{background:#f87171}
.status-dot.loading{background:#fbbf24;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.status-text{font-size:.75rem;color:#94a3b8}
.container{max-width:1440px;margin:0 auto;padding:1.5rem}

/* KPI Cards */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
.kpi-card{background:linear-gradient(135deg,#1e293b,#162032);border:1px solid #334155;border-radius:.75rem;padding:1.25rem;position:relative;overflow:hidden;transition:transform .15s,border-color .15s}
.kpi-card:hover{transform:translateY(-2px);border-color:#475569}
.kpi-card .icon{position:absolute;top:.75rem;right:.75rem;font-size:1.5rem;opacity:.25}
.kpi-card .label{font-size:.78rem;color:#94a3b8;margin-bottom:.35rem;font-weight:500}
.kpi-card .value{font-size:1.65rem;font-weight:700;color:#f1f5f9;letter-spacing:-0.02em}
.kpi-card .sub{font-size:.72rem;color:#64748b;margin-top:.3rem}
.kpi-card.blue .value{color:#38bdf8}
.kpi-card.green .value{color:#4ade80}
.kpi-card.amber .value{color:#fbbf24}
.kpi-card.purple .value{color:#a78bfa}
.kpi-card.pink .value{color:#fb7185}
.kpi-card.cyan .value{color:#22d3ee}

/* Chart grid */
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem}
.chart-box{background:#1e293b;border:1px solid #334155;border-radius:.75rem;padding:1rem 1.25rem}
.chart-box.full{grid-column:1/-1}
.chart-box h3{font-size:.85rem;color:#94a3b8;margin-bottom:.75rem;font-weight:600}
.chart-box canvas{width:100%!important;max-height:320px}

/* Table */
.table-section{background:#1e293b;border:1px solid #334155;border-radius:.75rem;padding:1.25rem;margin-bottom:2rem}
.table-section h3{font-size:.95rem;color:#94a3b8;margin-bottom:.75rem;font-weight:600}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.8rem}
thead th{background:#0f172a;color:#94a3b8;font-weight:600;padding:.6rem .75rem;text-align:left;position:sticky;top:0;border-bottom:2px solid #334155;white-space:nowrap}
tbody tr{border-bottom:1px solid #1e293b;transition:background .1s}
tbody tr:hover{background:#162032}
tbody td{padding:.55rem .75rem;white-space:nowrap}
tbody td:first-child{color:#e2e8f0;font-weight:500}
.loading-overlay{position:fixed;inset:0;background:rgba(15,23,42,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .3s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.spinner{width:48px;height:48px;border:4px solid #334155;border-top-color:#38bdf8;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay p{margin-top:1rem;color:#94a3b8;font-size:.9rem}
.error-banner{background:#7f1d1d;color:#fca5a5;border:1px solid #991b1b;border-radius:.5rem;padding:.75rem 1rem;margin-bottom:1rem;font-size:.85rem;display:none}

@media(max-width:900px){
    .chart-grid{grid-template-columns:1fr}
    .chart-box.full{grid-column:1}
    .header{padding:1rem}
    .container{padding:1rem}
}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<header class="header">
    <h1><span>M2</span> ì‹¤ì‹œê°„ ì»¨ì„¤íŒ… ëŒ€ì‹œë³´ë“œ</h1>
    <div class="controls">
        <label for="periodSelect">ê¸°ê°„:</label>
        <select id="periodSelect">
            <option value="0">ì „ì²´</option>
            <option value="7">ìµœê·¼ 7ì¼</option>
            <option value="14">14ì¼</option>
            <option value="30" selected>30ì¼</option>
            <option value="90">90ì¼</option>
            <option value="180">180ì¼</option>
            <option value="365">365ì¼</option>
        </select>
        <button onclick="fetchData()">ìƒˆë¡œê³ ì¹¨</button>
        <span><span class="status-dot loading" id="statusDot"></span><span class="status-text" id="statusText">ëŒ€ê¸° ì¤‘</span></span>
    </div>
</header>

<div class="container">
    <div class="error-banner" id="errorBanner"></div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card blue"><div class="icon">ğŸ“‹</div><div class="label">ì´ ë¬¸ì˜ ìˆ˜</div><div class="value" id="kpiInq">-</div><div class="sub" id="kpiInqSub"></div></div>
        <div class="kpi-card green"><div class="icon">âœ…</div><div class="label">ì „í™˜ ìˆ˜</div><div class="value" id="kpiConv">-</div><div class="sub" id="kpiConvSub"></div></div>
        <div class="kpi-card amber"><div class="icon">ğŸ“Š</div><div class="label">ì „í™˜ìœ¨</div><div class="value" id="kpiRate">-</div><div class="sub" id="kpiRateSub"></div></div>
        <div class="kpi-card pink"><div class="icon">ğŸ’°</div><div class="label">ì´ ì „í™˜ê°€ì¹˜</div><div class="value" id="kpiValue">-</div><div class="sub" id="kpiValueSub"></div></div>
        <div class="kpi-card cyan"><div class="icon">ğŸ“ˆ</div><div class="label">ì¼í‰ê·  ë¬¸ì˜</div><div class="value" id="kpiAvg">-</div><div class="sub" id="kpiAvgSub"></div></div>
    </div>

    <!-- Charts -->
    <div class="chart-grid">
        <div class="chart-box full"><h3>ì¼ë³„ ë¬¸ì˜ & ì „í™˜ ì¶”ì´</h3><canvas id="chartDaily"></canvas></div>
        <div class="chart-box"><h3>ìƒë‹´ì‚¬ë³„ ì„±ê³¼ (ë¬¸ì˜ / ì „í™˜)</h3><canvas id="chartConsPerf"></canvas></div>
        <div class="chart-box"><h3>ìƒë‹´ì‚¬ë³„ ì „í™˜ìœ¨</h3><canvas id="chartConsRate"></canvas></div>
        <div class="chart-box"><h3>ë¸Œëœë“œë³„ ë¬¸ì˜ & ì „í™˜</h3><canvas id="chartBrand"></canvas></div>
        <div class="chart-box"><h3>ìœ ì…ê²½ë¡œë³„ ë¶„í¬</h3><canvas id="chartChannel"></canvas></div>
        <div class="chart-box full"><h3>ìƒë‹´ì‚¬ë³„ ì „í™˜ê°€ì¹˜</h3><canvas id="chartConsValue"></canvas></div>
    </div>

    <!-- Table -->
    <div class="table-section">
        <h3>ì¼ë³„ ìƒì„¸ ë°ì´í„°</h3>
        <div class="table-wrap">
            <table>
                <thead><tr><th>ë‚ ì§œ</th><th>ë¬¸ì˜ìˆ˜</th><th>ì „í™˜ìˆ˜</th><th>ì „í™˜ìœ¨</th><th>ì „í™˜ê°€ì¹˜</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
/* â”€â”€â”€ Config â”€â”€â”€ */
const GID = '2096386829';
const ACTIVE_CONSULTANTS = ['íŒìŠ¹ë¹ˆ', 'ìµœí•´ì¸', 'ê°•í˜œìœ¤'];
const COLORS = {
    inq: '#38bdf8',
    conv: '#4ade80',
    channels: ['#38bdf8', '#4ade80', '#a78bfa', '#fbbf24', '#fb7185', '#22d3ee', '#f472b6', '#34d399']
};

let allRows = [];
let charts = {};

/* â”€â”€â”€ Parsing Helpers â”€â”€â”€ */
function parseWon(v) {
    if (!v || typeof v !== 'string') return 0;
    const s = v.replace(/[â‚©\s,]/g, '');
    if (s === '' || s === '-') return 0;
    return parseInt(s, 10) || 0;
}
function fmtWon(n) {
    if (n === 0) return 'â‚© 0';
    return 'â‚© ' + n.toLocaleString('ko-KR');
}
function fmtNum(n) {
    return n.toLocaleString('ko-KR');
}
function fmtDate(d) {
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const yr = d.getFullYear();
    return yr === 2025 ? `${mm}.${dd}` : `${yr}.${mm}.${dd}`;
}

/* â”€â”€â”€ Date Parser with year rollover â”€â”€â”€ */
let _parseYear = 2025;
let _prevMonth = 0;
function resetDateParser() { _parseYear = 2025; _prevMonth = 0; }
function parseDate(dateStr) {
    if (!dateStr) return null;
    const m = String(dateStr).match(/(\d{1,2})\.(\d{1,2})/);
    if (!m) return null;
    const month = parseInt(m[1], 10);
    const day = parseInt(m[2], 10);
    if (month < 1 || month > 12 || day < 1 || day > 31) return null;
    if (_prevMonth >= 10 && month <= 2) _parseYear++;
    _prevMonth = month;
    return new Date(_parseYear, month - 1, day);
}

/* â”€â”€â”€ Status â”€â”€â”€ */
function setStatus(type, text) {
    document.getElementById('statusDot').className = 'status-dot ' + type;
    document.getElementById('statusText').textContent = text;
}
function showError(msg) {
    const el = document.getElementById('errorBanner');
    el.textContent = msg;
    el.style.display = 'block';
}
function hideError() {
    document.getElementById('errorBanner').style.display = 'none';
}

/* â”€â”€â”€ Fetch & Parse â”€â”€â”€ */
async function fetchData() {
    setStatus('loading', 'ë°ì´í„° ë¡œë”© ì¤‘...');
    try {
        const resp = await fetch(`/api/sheet?gid=${GID}&_t=${Date.now()}`);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const csvText = await resp.text();
        const parsed = Papa.parse(csvText, { skipEmptyLines: false });
        const rows = parsed.data;

        // Find header row
        let headerIdx = -1;
        for (let i = 0; i < Math.min(rows.length, 10); i++) {
            const rowStr = rows[i].join(',');
            if (rowStr.includes('ë¸Œëœë“œ') || rowStr.includes('í•™ìƒ')) {
                headerIdx = i;
                break;
            }
        }
        if (headerIdx === -1) headerIdx = 0;

        const dataStartIdx = headerIdx + 1;
        resetDateParser();
        const rawEntries = [];

        for (let i = dataStartIdx; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length < 10) continue;

            const id = (row[0] || '').trim();
            const brand = (row[1] || '').trim();
            const dateStr = (row[3] || '').trim();
            const channel = (row[5] || '').trim();
            const studentName = (row[8] || '').trim();
            const consultant = (row[16] || '').trim();
            const payment = (row[19] || '').trim();
            const convValueStr = (row[21] || '').trim();

            if (!id && !brand && !studentName) continue;

            const dt = parseDate(dateStr);
            const isConverted = payment.toUpperCase() === 'O';
            const convValue = parseWon(convValueStr);

            rawEntries.push({ id, brand, dateStr, dt, channel, studentName, consultant, isConverted, convValue });
        }

        // Fill missing dates from surrounding rows
        for (let i = 0; i < rawEntries.length; i++) {
            if (rawEntries[i].dt) continue;
            let prevDate = null;
            for (let j = i - 1; j >= 0; j--) {
                if (rawEntries[j].dt) { prevDate = rawEntries[j].dt; break; }
            }
            let nextDate = null;
            for (let j = i + 1; j < rawEntries.length; j++) {
                if (rawEntries[j].dt) { nextDate = rawEntries[j].dt; break; }
            }
            rawEntries[i].dt = prevDate || nextDate;
        }

        allRows = rawEntries.filter(e => e.dt !== null);

        setStatus('ok', `${allRows.length}ê±´ ë¡œë“œ ì™„ë£Œ`);
        hideError();
        render();
    } catch (err) {
        setStatus('err', 'ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        showError('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    }
}

/* â”€â”€â”€ Filtering â”€â”€â”€ */
function getFilteredRows() {
    const days = parseInt(document.getElementById('periodSelect').value);
    if (days === 0 || allRows.length === 0) return allRows;
    const maxDate = allRows.reduce((mx, r) => r.dt > mx ? r.dt : mx, allRows[0].dt);
    const from = new Date(maxDate);
    from.setDate(from.getDate() - days + 1);
    return allRows.filter(r => r.dt >= from && r.dt <= maxDate);
}

/* â”€â”€â”€ Render All â”€â”€â”€ */
function render() {
    const rows = getFilteredRows();
    renderKPIs(rows);
    renderCharts(rows);
    renderTable(rows);
    document.getElementById('loadingOverlay').classList.add('hidden');
}

/* â”€â”€â”€ KPIs â”€â”€â”€ */
function renderKPIs(rows) {
    const total = rows.length;
    const converted = rows.filter(r => r.isConverted).length;
    const rate = total > 0 ? (converted / total * 100) : 0;
    const totalValue = rows.reduce((s, r) => s + r.convValue, 0);
    const dateSet = new Set(rows.map(r => r.dt.toDateString()));
    const numDays = dateSet.size || 1;
    const avgInq = total / numDays;

    document.getElementById('kpiInq').textContent = fmtNum(total);
    document.getElementById('kpiInqSub').textContent = `${numDays}ì¼ê°„ ì´ ë¬¸ì˜`;
    document.getElementById('kpiConv').textContent = fmtNum(converted);
    document.getElementById('kpiConvSub').textContent = `ê²°ì œ ì™„ë£Œ ê±´ìˆ˜`;
    document.getElementById('kpiRate').textContent = rate.toFixed(1) + '%';
    document.getElementById('kpiRateSub').textContent = `ë¬¸ì˜ ëŒ€ë¹„ ì „í™˜`;
    document.getElementById('kpiValue').textContent = fmtWon(totalValue);
    document.getElementById('kpiValueSub').textContent = `ì „í™˜ ì´ ê°€ì¹˜`;
    document.getElementById('kpiAvg').textContent = avgInq.toFixed(1);
    document.getElementById('kpiAvgSub').textContent = `ì¼ í‰ê·  ë¬¸ì˜`;
}

/* â”€â”€â”€ Chart Helpers â”€â”€â”€ */
const chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: { labels: { color: '#94a3b8', font: { size: 11 } } },
        tooltip: {
            backgroundColor: '#1e293b', titleColor: '#f1f5f9', bodyColor: '#e2e8f0',
            borderColor: '#334155', borderWidth: 1, padding: 10, cornerRadius: 8
        }
    },
    scales: {
        x: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: '#1e293b' } },
        y: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: '#1e293b' }, beginAtZero: true }
    }
};
function makeCtx(id) { return document.getElementById(id).getContext('2d'); }
function destroyChart(key) { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }
function cloneDefaults() { return JSON.parse(JSON.stringify(chartDefaults)); }

/* â”€â”€â”€ Render Charts â”€â”€â”€ */
function renderCharts(rows) {
    // Aggregate by date
    const dailyMap = {};
    rows.forEach(r => {
        const key = fmtDate(r.dt);
        if (!dailyMap[key]) dailyMap[key] = { date: r.dt, inq: 0, conv: 0, value: 0 };
        dailyMap[key].inq++;
        if (r.isConverted) { dailyMap[key].conv++; dailyMap[key].value += r.convValue; }
    });
    const dailyKeys = Object.keys(dailyMap).sort((a, b) => dailyMap[a].date - dailyMap[b].date);

    // 1) Daily inquiry & conversion
    destroyChart('daily');
    charts.daily = new Chart(makeCtx('chartDaily'), {
        type: 'bar',
        data: {
            labels: dailyKeys,
            datasets: [
                { label: 'ë¬¸ì˜', data: dailyKeys.map(k => dailyMap[k].inq), backgroundColor: COLORS.inq + 'cc', borderRadius: 3 },
                { label: 'ì „í™˜', data: dailyKeys.map(k => dailyMap[k].conv), backgroundColor: COLORS.conv + 'cc', borderRadius: 3 }
            ]
        },
        options: {
            ...cloneDefaults(), responsive: true, maintainAspectRatio: false,
            plugins: { ...chartDefaults.plugins },
            scales: {
                x: { ticks: { color: '#64748b', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#1e293b' } },
                y: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }
            }
        }
    });

    // Aggregate by consultant
    const consMap = {};
    rows.forEach(r => {
        const c = r.consultant || '(ë¯¸ë°°ì •)';
        if (!consMap[c]) consMap[c] = { inq: 0, conv: 0, value: 0 };
        consMap[c].inq++;
        if (r.isConverted) { consMap[c].conv++; consMap[c].value += r.convValue; }
    });
    const consNames = [
        ...ACTIVE_CONSULTANTS.filter(c => consMap[c]),
        ...Object.keys(consMap).filter(c => !ACTIVE_CONSULTANTS.includes(c)).sort((a, b) => consMap[b].inq - consMap[a].inq)
    ];
    const consInq = consNames.map(c => consMap[c].inq);
    const consConv = consNames.map(c => consMap[c].conv);
    const consValue = consNames.map(c => consMap[c].value);
    const consColors = consNames.map((_, i) => COLORS.channels[i % COLORS.channels.length] + 'cc');

    // 2) Consultant performance
    destroyChart('consPerf');
    charts.consPerf = new Chart(makeCtx('chartConsPerf'), {
        type: 'bar',
        data: {
            labels: consNames,
            datasets: [
                { label: 'ë¬¸ì˜', data: consInq, backgroundColor: COLORS.inq + 'cc', borderRadius: 4 },
                { label: 'ì „í™˜', data: consConv, backgroundColor: COLORS.conv + 'cc', borderRadius: 4 }
            ]
        },
        options: {
            ...cloneDefaults(), responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { ...chartDefaults.plugins },
            scales: {
                x: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
                y: { ticks: { color: '#e2e8f0', font: { size: 12 } }, grid: { color: '#1e293b' } }
            }
        }
    });

    // 3) Consultant conversion rate
    destroyChart('consRate');
    const consRates = consNames.map((_, i) => consInq[i] > 0 ? +(consConv[i] / consInq[i] * 100).toFixed(1) : 0);
    charts.consRate = new Chart(makeCtx('chartConsRate'), {
        type: 'bar',
        data: {
            labels: consNames,
            datasets: [{ label: 'ì „í™˜ìœ¨ (%)', data: consRates, backgroundColor: consColors, borderRadius: 4 }]
        },
        options: {
            ...cloneDefaults(), responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { ...chartDefaults.plugins, legend: { display: false } },
            scales: {
                x: { beginAtZero: true, ticks: { color: '#64748b', callback: v => v + '%' }, grid: { color: '#1e293b' } },
                y: { ticks: { color: '#e2e8f0', font: { size: 12 } }, grid: { color: '#1e293b' } }
            }
        }
    });

    // Aggregate by brand
    const brandMap = {};
    rows.forEach(r => {
        const b = r.brand || '(ê¸°íƒ€)';
        if (!brandMap[b]) brandMap[b] = { inq: 0, conv: 0 };
        brandMap[b].inq++;
        if (r.isConverted) brandMap[b].conv++;
    });
    const brandNames = Object.keys(brandMap).sort((a, b) => brandMap[b].inq - brandMap[a].inq);

    // 4) Brand breakdown
    destroyChart('brand');
    charts.brand = new Chart(makeCtx('chartBrand'), {
        type: 'bar',
        data: {
            labels: brandNames,
            datasets: [
                { label: 'ë¬¸ì˜', data: brandNames.map(b => brandMap[b].inq), backgroundColor: COLORS.inq + 'cc', borderRadius: 4 },
                { label: 'ì „í™˜', data: brandNames.map(b => brandMap[b].conv), backgroundColor: COLORS.conv + 'cc', borderRadius: 4 }
            ]
        },
        options: {
            ...cloneDefaults(), responsive: true, maintainAspectRatio: false,
            plugins: { ...chartDefaults.plugins },
            scales: {
                x: { ticks: { color: '#e2e8f0', font: { size: 11 } }, grid: { color: '#1e293b' } },
                y: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }
            }
        }
    });

    // Aggregate by channel
    const chanMap = {};
    rows.forEach(r => {
        const ch = r.channel || '(ë¯¸ë¶„ë¥˜)';
        if (!chanMap[ch]) chanMap[ch] = 0;
        chanMap[ch]++;
    });
    const chanNames = Object.keys(chanMap).sort((a, b) => chanMap[b] - chanMap[a]);

    // 5) Channel distribution
    destroyChart('channel');
    charts.channel = new Chart(makeCtx('chartChannel'), {
        type: 'bar',
        data: {
            labels: chanNames,
            datasets: [{
                label: 'ë¬¸ì˜ìˆ˜',
                data: chanNames.map(c => chanMap[c]),
                backgroundColor: chanNames.map((_, i) => COLORS.channels[i % COLORS.channels.length] + 'cc'),
                borderRadius: 4
            }]
        },
        options: {
            ...cloneDefaults(), responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { ...chartDefaults.plugins, legend: { display: false } },
            scales: {
                x: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
                y: { ticks: { color: '#e2e8f0', font: { size: 11 } }, grid: { color: '#1e293b' } }
            }
        }
    });

    // 6) Consultant conversion value
    destroyChart('consValue');
    charts.consValue = new Chart(makeCtx('chartConsValue'), {
        type: 'bar',
        data: {
            labels: consNames,
            datasets: [{ label: 'ì „í™˜ê°€ì¹˜', data: consValue, backgroundColor: consColors, borderRadius: 4 }]
        },
        options: {
            ...cloneDefaults(), responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { ...chartDefaults.plugins, legend: { display: false } },
            scales: {
                x: { beginAtZero: true, ticks: { color: '#64748b', callback: v => 'â‚©' + (v/10000).toFixed(0) + 'ë§Œ' }, grid: { color: '#1e293b' } },
                y: { ticks: { color: '#e2e8f0', font: { size: 12 } }, grid: { color: '#1e293b' } }
            }
        }
    });
}

/* â”€â”€â”€ Table â”€â”€â”€ */
function renderTable(rows) {
    const dailyMap = {};
    rows.forEach(r => {
        const key = r.dt.toDateString();
        if (!dailyMap[key]) dailyMap[key] = { date: r.dt, inq: 0, conv: 0, value: 0 };
        dailyMap[key].inq++;
        if (r.isConverted) { dailyMap[key].conv++; dailyMap[key].value += r.convValue; }
    });
    const sorted = Object.values(dailyMap).sort((a, b) => b.date - a.date);
    document.getElementById('tableBody').innerHTML = sorted.map(d => {
        const rate = d.inq > 0 ? (d.conv / d.inq * 100).toFixed(1) + '%' : '-';
        return `<tr>
            <td>${fmtDate(d.date)}</td>
            <td>${fmtNum(d.inq)}</td>
            <td>${fmtNum(d.conv)}</td>
            <td>${rate}</td>
            <td>${fmtWon(d.value)}</td>
        </tr>`;
    }).join('');
}

/* â”€â”€â”€ Events & Init â”€â”€â”€ */
document.getElementById('periodSelect').addEventListener('change', render);
fetchData();
setInterval(fetchData, 5 * 60 * 1000);
</script>
</body>
</html>
