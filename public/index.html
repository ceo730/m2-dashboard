<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M2 ì»¨ì„¤íŒ… ì „í™˜ì½œ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI','Malgun Gothic',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
a{color:#38bdf8}
.header{background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border-bottom:1px solid #1e293b;padding:1.25rem 2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
.header h1{font-size:1.5rem;font-weight:700;color:#f1f5f9;letter-spacing:-0.02em}
.header h1 span{color:#38bdf8}
.controls{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.controls label{font-size:.8rem;color:#94a3b8}
.controls select,.controls button{background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:.5rem;padding:.45rem .9rem;font-size:.8rem;cursor:pointer;transition:all .15s}
.controls select:hover,.controls button:hover{border-color:#38bdf8;background:#1e3a5f}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:.4rem}
.status-dot.ok{background:#4ade80}
.status-dot.err{background:#f87171}
.status-dot.loading{background:#fbbf24;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.status-text{font-size:.75rem;color:#94a3b8}
.container{max-width:1440px;margin:0 auto;padding:1.5rem}

/* KPI Cards */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
.kpi-card{background:linear-gradient(135deg,#1e293b,#162032);border:1px solid #334155;border-radius:.75rem;padding:1.25rem;position:relative;overflow:hidden;transition:transform .15s,border-color .15s}
.kpi-card:hover{transform:translateY(-2px);border-color:#475569}
.kpi-card .icon{position:absolute;top:.75rem;right:.75rem;font-size:1.5rem;opacity:.25}
.kpi-card .label{font-size:.78rem;color:#94a3b8;margin-bottom:.35rem;font-weight:500}
.kpi-card .value{font-size:1.65rem;font-weight:700;color:#f1f5f9;letter-spacing:-0.02em}
.kpi-card .sub{font-size:.72rem;color:#64748b;margin-top:.3rem}
.kpi-card.blue .value{color:#38bdf8}
.kpi-card.green .value{color:#4ade80}
.kpi-card.amber .value{color:#fbbf24}
.kpi-card.purple .value{color:#a78bfa}
.kpi-card.pink .value{color:#fb7185}
.kpi-card.cyan .value{color:#22d3ee}

/* Chart grid */
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem}
.chart-box{background:#1e293b;border:1px solid #334155;border-radius:.75rem;padding:1rem 1.25rem}
.chart-box.full{grid-column:1/-1}
.chart-box h3{font-size:.85rem;color:#94a3b8;margin-bottom:.75rem;font-weight:600}
.chart-box canvas{width:100%!important;max-height:320px}

/* Table */
.table-section{background:#1e293b;border:1px solid #334155;border-radius:.75rem;padding:1.25rem;margin-bottom:2rem}
.table-section h3{font-size:.95rem;color:#94a3b8;margin-bottom:.75rem;font-weight:600}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.8rem}
thead th{background:#0f172a;color:#94a3b8;font-weight:600;padding:.6rem .75rem;text-align:left;position:sticky;top:0;border-bottom:2px solid #334155;white-space:nowrap}
tbody tr{border-bottom:1px solid #1e293b;transition:background .1s}
tbody tr:hover{background:#162032}
tbody td{padding:.55rem .75rem;white-space:nowrap}
tbody td:first-child{color:#e2e8f0;font-weight:500}
.loading-overlay{position:fixed;inset:0;background:rgba(15,23,42,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .3s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.spinner{width:48px;height:48px;border:4px solid #334155;border-top-color:#38bdf8;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay p{margin-top:1rem;color:#94a3b8;font-size:.9rem}
.error-banner{background:#7f1d1d;color:#fca5a5;border:1px solid #991b1b;border-radius:.5rem;padding:.75rem 1rem;margin-bottom:1rem;font-size:.85rem;display:none}
@media(max-width:900px){
    .chart-grid{grid-template-columns:1fr}
    .chart-box.full{grid-column:1}
    .header{padding:1rem}
    .container{padding:1rem}
}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<header class="header">
    <h1><span>M2</span> ì»¨ì„¤íŒ… ì „í™˜ì½œ ëŒ€ì‹œë³´ë“œ</h1>
    <div class="controls">
        <label for="periodSelect">ê¸°ê°„:</label>
        <select id="periodSelect">
            <option value="0">ì „ì²´</option>
            <option value="7">ìµœê·¼ 7ì¼</option>
            <option value="14">14ì¼</option>
            <option value="30" selected>30ì¼</option>
            <option value="90">90ì¼</option>
            <option value="180">180ì¼</option>
            <option value="365">365ì¼</option>
        </select>
        <button onclick="refreshData()">ìƒˆë¡œê³ ì¹¨</button>
        <span><span class="status-dot loading" id="statusDot"></span><span class="status-text" id="statusText">ëŒ€ê¸° ì¤‘</span></span>
    </div>
</header>

<div class="container">
    <div class="error-banner" id="errorBanner"></div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card blue"><div class="icon">ğŸ“</div><div class="label">ì´ ì½œ ìˆ˜</div><div class="value" id="kpiCalls">-</div><div class="sub" id="kpiCallsSub"></div></div>
        <div class="kpi-card green"><div class="icon">âœ…</div><div class="label">ì´ ì „í™˜ ìˆ˜</div><div class="value" id="kpiConv">-</div><div class="sub" id="kpiConvSub"></div></div>
        <div class="kpi-card amber"><div class="icon">ğŸ“Š</div><div class="label">ì „í™˜ìœ¨</div><div class="value" id="kpiRate">-</div><div class="sub" id="kpiRateSub"></div></div>
        <div class="kpi-card pink"><div class="icon">ğŸ’°</div><div class="label">ì´ ì „í™˜ê°€ì¹˜</div><div class="value" id="kpiValue">-</div><div class="sub" id="kpiValueSub"></div></div>
        <div class="kpi-card purple"><div class="icon">ğŸ¢</div><div class="label">M2 ë§¤ì¶œ í•©ê³„</div><div class="value" id="kpiRevenue">-</div><div class="sub" id="kpiRevenueSub"></div></div>
        <div class="kpi-card cyan"><div class="icon">ğŸ“ˆ</div><div class="label">ì¼ í‰ê·  ì½œ</div><div class="value" id="kpiAvgCalls">-</div><div class="sub" id="kpiAvgCallsSub"></div></div>
    </div>

    <!-- Charts -->
    <div class="chart-grid">
        <div class="chart-box full"><h3>ì¼ë³„ ì½œ & ì „í™˜ ì¶”ì´</h3><canvas id="chartDailyCallConv"></canvas></div>
        <div class="chart-box"><h3>ì¼ë³„ ì „í™˜ìœ¨ ì¶”ì´</h3><canvas id="chartDailyRate"></canvas></div>
        <div class="chart-box"><h3>ëˆ„ì  ì „í™˜ê°€ì¹˜ & M2 ë§¤ì¶œ</h3><canvas id="chartCumulative"></canvas></div>
        <div class="chart-box full"><h3>ì»¨ì„¤í„´íŠ¸ë³„ ì„±ê³¼ ë¹„êµ (ì½œ / ì „í™˜)</h3><canvas id="chartConsultantPerf"></canvas></div>
        <div class="chart-box"><h3>ì»¨ì„¤í„´íŠ¸ë³„ ì „í™˜ìœ¨</h3><canvas id="chartConsultantRate"></canvas></div>
        <div class="chart-box"><h3>ì»¨ì„¤í„´íŠ¸ë³„ ì „í™˜ê°€ì¹˜</h3><canvas id="chartConsultantValue"></canvas></div>
        <div class="chart-box"><h3>ìš”ì¼ë³„ ì½œ & ì „í™˜ ë¶„í¬</h3><canvas id="chartDayOfWeek"></canvas></div>
        <div class="chart-box"><h3>ì£¼ê°„ ì¶”ì´</h3><canvas id="chartWeekly"></canvas></div>
    </div>

    <!-- Table -->
    <div class="table-section">
        <h3>ì¼ë³„ ìƒì„¸ ë°ì´í„°</h3>
        <div class="table-wrap">
            <table>
                <thead><tr><th>ë‚ ì§œ</th><th>ìš”ì¼</th><th>ì‹ ê·œ</th><th>ì½œ</th><th>ì „í™˜</th><th>ì „í™˜ìœ¨</th><th>ì „í™˜ê°€ì¹˜</th><th>M2 ë§¤ì¶œ</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
/* â”€â”€â”€ Config â”€â”€â”€ */
const GID = '1133198386';
const CONSULTANTS = [
    { name: 'í™©ìƒí˜„', offset: 11 },
    { name: 'íŒìŠ¹ë¹ˆ', offset: 18 },
    { name: 'ìµœí•´ì¸', offset: 25 },
    { name: 'ì´í˜¸ì„±', offset: 32 },
    { name: 'ì†¡ë¯¼ì£¼', offset: 39 },
    { name: 'í•œì˜í›ˆ', offset: 46 },
    { name: 'ì•ˆì†Œì€', offset: 53 },
];
const COLORS = {
    calls: '#38bdf8',
    conv: '#4ade80',
    revenue: '#fbbf24',
    m2: '#a78bfa',
    consultants: ['#38bdf8','#4ade80','#a78bfa','#fbbf24','#fb7185','#22d3ee','#f472b6']
};
const DAY_NAMES = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

let allRows = [];
let charts = {};

/* â”€â”€â”€ Parsing Helpers â”€â”€â”€ */
function parseWon(v) {
    if (!v || typeof v !== 'string') return 0;
    const s = v.replace(/[â‚©\s,]/g, '');
    if (s === '' || s === '-') return 0;
    return parseInt(s, 10) || 0;
}
function parsePct(v) {
    if (!v || typeof v !== 'string') return 0;
    const s = v.replace(/[%\s]/g, '');
    if (s === '' || s === '-') return 0;
    return parseFloat(s) || 0;
}
function parseNum(v) {
    if (v === null || v === undefined) return 0;
    const s = String(v).replace(/[,\s]/g, '');
    if (s === '' || s === '-') return 0;
    return parseInt(s, 10) || 0;
}
function parseDate(dateStr) {
    if (!dateStr) return null;
    const m = String(dateStr).match(/(\d{2})\.(\d{2})/);
    if (!m) return null;
    const month = parseInt(m[1], 10);
    const day = parseInt(m[2], 10);
    if (month < 1 || month > 12 || day < 1 || day > 31) return null;
    return new Date(2025, month - 1, day);
}
function extractDayName(dateStr) {
    if (!dateStr) return '';
    const m = String(dateStr).match(/\((.)\)/);
    return m ? m[1] : '';
}
function fmtWon(n) {
    if (n === 0) return 'â‚© 0';
    return 'â‚© ' + n.toLocaleString('ko-KR');
}
function fmtNum(n) {
    return n.toLocaleString('ko-KR');
}
function fmtDate(d) {
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${mm}.${dd}`;
}

/* â”€â”€â”€ Data Fetch â”€â”€â”€ */
async function fetchData() {
    setStatus('loading', 'ë°ì´í„° ë¡œë”© ì¤‘...');
    try {
        const resp = await fetch(`/api/sheet?gid=${GID}&_t=${Date.now()}`);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const csvText = await resp.text();
        const parsed = Papa.parse(csvText, { skipEmptyLines: false });
        const rows = parsed.data;

        // Find header row (the row that contains "ì‹ ê·œ" and "ì½œ")
        let headerIdx = -1;
        for (let i = 0; i < Math.min(rows.length, 10); i++) {
            const rowStr = rows[i].join(',');
            if (rowStr.includes('ì‹ ê·œ') && rowStr.includes('ì½œ')) {
                headerIdx = i;
                break;
            }
        }
        if (headerIdx === -1) headerIdx = 2; // fallback: assume 3 header rows (0,1,2)

        // Data rows start after the header row
        const dataStartIdx = headerIdx + 1;
        allRows = [];
        for (let i = dataStartIdx; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length < 5) continue;
            const dateStr = (row[0] || '').trim();
            const dt = parseDate(dateStr);
            if (!dt) continue;

            const entry = {
                dateStr: dateStr,
                date: dt,
                dayName: extractDayName(dateStr),
                sinGyu: parseNum(row[1]),
                calls: parseNum(row[2]),
                conv: parseNum(row[3]),
                convValue: parseWon(row[4]),
                convRate: parsePct(row[5]),
                m2Revenue: parseWon(row[9]),
                consultants: {}
            };

            CONSULTANTS.forEach(c => {
                entry.consultants[c.name] = {
                    calls: parseNum(row[c.offset]),
                    noContact: parseNum(row[c.offset + 1]),
                    conv: parseNum(row[c.offset + 2]),
                    convValue: parseWon(row[c.offset + 3]),
                    convRate: parsePct(row[c.offset + 4]),
                    oldConv: parseNum(row[c.offset + 5]),
                    oldConvValue: parseWon(row[c.offset + 6]),
                };
            });

            allRows.push(entry);
        }

        // Sort by date ascending
        allRows.sort((a, b) => a.date - b.date);

        setStatus('ok', `${allRows.length}ì¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
        hideError();
        render();
    } catch (err) {
        setStatus('err', 'ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        showError('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    }
}

/* â”€â”€â”€ Status â”€â”€â”€ */
function setStatus(type, text) {
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    dot.className = 'status-dot ' + type;
    txt.textContent = text;
}
function showError(msg) {
    const el = document.getElementById('errorBanner');
    el.textContent = msg;
    el.style.display = 'block';
}
function hideError() {
    document.getElementById('errorBanner').style.display = 'none';
}

/* â”€â”€â”€ Filtering â”€â”€â”€ */
function getFilteredRows() {
    const days = parseInt(document.getElementById('periodSelect').value);
    if (days === 0) return allRows;
    const cutoff = new Date(2025, 0, 1);
    const now = allRows.length > 0 ? allRows[allRows.length - 1].date : new Date(2025, 7, 25);
    const from = new Date(now);
    from.setDate(from.getDate() - days + 1);
    return allRows.filter(r => r.date >= from && r.date <= now);
}

/* â”€â”€â”€ Render All â”€â”€â”€ */
function render() {
    const rows = getFilteredRows();
    renderKPIs(rows);
    renderCharts(rows);
    renderTable(rows);
    document.getElementById('loadingOverlay').classList.add('hidden');
}

/* â”€â”€â”€ KPIs â”€â”€â”€ */
function renderKPIs(rows) {
    const totalCalls = rows.reduce((s, r) => s + r.calls, 0);
    const totalConv = rows.reduce((s, r) => s + r.conv, 0);
    const totalValue = rows.reduce((s, r) => s + r.convValue, 0);
    const totalM2 = rows.reduce((s, r) => s + r.m2Revenue, 0);
    const rate = totalCalls > 0 ? (totalConv / totalCalls * 100) : 0;
    const avgCalls = rows.length > 0 ? (totalCalls / rows.length) : 0;

    document.getElementById('kpiCalls').textContent = fmtNum(totalCalls);
    document.getElementById('kpiCallsSub').textContent = `${rows.length}ì¼ê°„ ì´ ì½œ`;
    document.getElementById('kpiConv').textContent = fmtNum(totalConv);
    document.getElementById('kpiConvSub').textContent = `ì „ì²´ ì „í™˜ ê±´ìˆ˜`;
    document.getElementById('kpiRate').textContent = rate.toFixed(1) + '%';
    document.getElementById('kpiRateSub').textContent = `ì½œ ëŒ€ë¹„ ì „í™˜`;
    document.getElementById('kpiValue').textContent = fmtWon(totalValue);
    document.getElementById('kpiValueSub').textContent = `ì „í™˜ ì´ ê°€ì¹˜`;
    document.getElementById('kpiRevenue').textContent = fmtWon(totalM2);
    document.getElementById('kpiRevenueSub').textContent = `M2 ë§¤ì¶œ í•©ê³„`;
    document.getElementById('kpiAvgCalls').textContent = avgCalls.toFixed(1);
    document.getElementById('kpiAvgCallsSub').textContent = `ì¼ í‰ê· `;
}

/* â”€â”€â”€ Chart Helpers â”€â”€â”€ */
const chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: { labels: { color: '#94a3b8', font: { size: 11 } } },
        tooltip: {
            backgroundColor: '#1e293b',
            titleColor: '#f1f5f9',
            bodyColor: '#e2e8f0',
            borderColor: '#334155',
            borderWidth: 1,
            padding: 10,
            cornerRadius: 8
        }
    },
    scales: {
        x: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: '#1e293b' } },
        y: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: '#1e293b' }, beginAtZero: true }
    }
};

function makeCtx(id) {
    return document.getElementById(id).getContext('2d');
}

function destroyChart(key) {
    if (charts[key]) { charts[key].destroy(); charts[key] = null; }
}

function cloneDefaults(overrides) {
    return JSON.parse(JSON.stringify(chartDefaults));
}

/* â”€â”€â”€ Render Charts â”€â”€â”€ */
function renderCharts(rows) {
    const labels = rows.map(r => fmtDate(r.date));

    // 1) Daily calls & conversions (full width bar)
    destroyChart('dailyCallConv');
    charts.dailyCallConv = new Chart(makeCtx('chartDailyCallConv'), {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'ì½œ', data: rows.map(r => r.calls), backgroundColor: COLORS.calls + 'cc', borderRadius: 3 },
                { label: 'ì „í™˜', data: rows.map(r => r.conv), backgroundColor: COLORS.conv + 'cc', borderRadius: 3 }
            ]
        },
        options: {
            ...cloneDefaults(),
            responsive: true,
            maintainAspectRatio: false,
            plugins: { ...chartDefaults.plugins },
            scales: {
                x: { stacked: false, ticks: { color: '#64748b', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#1e293b' } },
                y: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }
            }
        }
    });

    // 2) Daily conversion rate (line)
    destroyChart('dailyRate');
    charts.dailyRate = new Chart(makeCtx('chartDailyRate'), {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'ì „í™˜ìœ¨ (%)',
                data: rows.map(r => r.calls > 0 ? +(r.conv / r.calls * 100).toFixed(1) : 0),
                borderColor: COLORS.conv,
                backgroundColor: COLORS.conv + '22',
                fill: true,
                tension: 0.3,
                pointRadius: rows.length > 60 ? 0 : 2
            }]
        },
        options: {
            ...cloneDefaults(),
            responsive: true, maintainAspectRatio: false,
            plugins: { ...chartDefaults.plugins },
            scales: {
                x: { ticks: { color: '#64748b', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#1e293b' } },
                y: { beginAtZero: true, ticks: { color: '#64748b', callback: v => v + '%' }, grid: { color: '#1e293b' } }
            }
        }
    });

    // 3) Cumulative conversion value & M2 revenue (dual line)
    destroyChart('cumulative');
    let cumVal = 0, cumM2 = 0;
    const cumValArr = rows.map(r => { cumVal += r.convValue; return cumVal; });
    const cumM2Arr = rows.map(r => { cumM2 += r.m2Revenue; return cumM2; });
    charts.cumulative = new Chart(makeCtx('chartCumulative'), {
        type: 'line',
        data: {
            labels,
            datasets: [
                { label: 'ëˆ„ì  ì „í™˜ê°€ì¹˜', data: cumValArr, borderColor: COLORS.revenue, backgroundColor: COLORS.revenue + '18', fill: true, tension: 0.3, pointRadius: 0 },
                { label: 'ëˆ„ì  M2 ë§¤ì¶œ', data: cumM2Arr, borderColor: COLORS.m2, backgroundColor: COLORS.m2 + '18', fill: true, tension: 0.3, pointRadius: 0 }
            ]
        },
        options: {
            ...cloneDefaults(),
            responsive: true, maintainAspectRatio: false,
            plugins: { ...chartDefaults.plugins },
            scales: {
                x: { ticks: { color: '#64748b', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#1e293b' } },
                y: { beginAtZero: true, ticks: { color: '#64748b', callback: v => 'â‚©' + (v/10000).toFixed(0) + 'ë§Œ' }, grid: { color: '#1e293b' } }
            }
        }
    });

    // 4) Consultant performance comparison (horizontal grouped bar: calls + conv)
    destroyChart('consultantPerf');
    const cNames = CONSULTANTS.map(c => c.name);
    const cCalls = CONSULTANTS.map(c => rows.reduce((s, r) => s + (r.consultants[c.name]?.calls || 0), 0));
    const cConv = CONSULTANTS.map(c => rows.reduce((s, r) => s + (r.consultants[c.name]?.conv || 0), 0));
    charts.consultantPerf = new Chart(makeCtx('chartConsultantPerf'), {
        type: 'bar',
        data: {
            labels: cNames,
            datasets: [
                { label: 'ì½œ', data: cCalls, backgroundColor: COLORS.calls + 'cc', borderRadius: 4 },
                { label: 'ì „í™˜', data: cConv, backgroundColor: COLORS.conv + 'cc', borderRadius: 4 }
            ]
        },
        options: {
            ...cloneDefaults(),
            responsive: true, maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { ...chartDefaults.plugins },
            scales: {
                x: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
                y: { ticks: { color: '#e2e8f0', font: { size: 12 } }, grid: { color: '#1e293b' } }
            }
        }
    });

    // 5) Consultant conversion rate (horizontal bar)
    destroyChart('consultantRate');
    const cRates = CONSULTANTS.map((c, i) => cCalls[i] > 0 ? +(cConv[i] / cCalls[i] * 100).toFixed(1) : 0);
    charts.consultantRate = new Chart(makeCtx('chartConsultantRate'), {
        type: 'bar',
        data: {
            labels: cNames,
            datasets: [{ label: 'ì „í™˜ìœ¨ (%)', data: cRates, backgroundColor: COLORS.consultants.map(c => c + 'cc'), borderRadius: 4 }]
        },
        options: {
            ...cloneDefaults(),
            responsive: true, maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { ...chartDefaults.plugins, legend: { display: false } },
            scales: {
                x: { beginAtZero: true, ticks: { color: '#64748b', callback: v => v + '%' }, grid: { color: '#1e293b' } },
                y: { ticks: { color: '#e2e8f0', font: { size: 12 } }, grid: { color: '#1e293b' } }
            }
        }
    });

    // 6) Consultant conversion value (horizontal bar)
    destroyChart('consultantValue');
    const cValues = CONSULTANTS.map(c => rows.reduce((s, r) => s + (r.consultants[c.name]?.convValue || 0), 0));
    charts.consultantValue = new Chart(makeCtx('chartConsultantValue'), {
        type: 'bar',
        data: {
            labels: cNames,
            datasets: [{ label: 'ì „í™˜ê°€ì¹˜', data: cValues, backgroundColor: COLORS.consultants.map(c => c + 'cc'), borderRadius: 4 }]
        },
        options: {
            ...cloneDefaults(),
            responsive: true, maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { ...chartDefaults.plugins, legend: { display: false } },
            scales: {
                x: { beginAtZero: true, ticks: { color: '#64748b', callback: v => 'â‚©' + (v/10000).toFixed(0) + 'ë§Œ' }, grid: { color: '#1e293b' } },
                y: { ticks: { color: '#e2e8f0', font: { size: 12 } }, grid: { color: '#1e293b' } }
            }
        }
    });

    // 7) Day-of-week distribution (bar chart ì¼~í† )
    destroyChart('dayOfWeek');
    const dowCalls = new Array(7).fill(0);
    const dowConv = new Array(7).fill(0);
    const dayMap = { 'ì¼': 0, 'ì›”': 1, 'í™”': 2, 'ìˆ˜': 3, 'ëª©': 4, 'ê¸ˆ': 5, 'í† ': 6 };
    rows.forEach(r => {
        const di = dayMap[r.dayName];
        if (di !== undefined) {
            dowCalls[di] += r.calls;
            dowConv[di] += r.conv;
        }
    });
    charts.dayOfWeek = new Chart(makeCtx('chartDayOfWeek'), {
        type: 'bar',
        data: {
            labels: DAY_NAMES,
            datasets: [
                { label: 'ì½œ', data: dowCalls, backgroundColor: COLORS.calls + 'cc', borderRadius: 4 },
                { label: 'ì „í™˜', data: dowConv, backgroundColor: COLORS.conv + 'cc', borderRadius: 4 }
            ]
        },
        options: {
            ...cloneDefaults(),
            responsive: true, maintainAspectRatio: false,
            plugins: { ...chartDefaults.plugins },
            scales: {
                x: { ticks: { color: '#e2e8f0', font: { size: 12 } }, grid: { color: '#1e293b' } },
                y: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }
            }
        }
    });

    // 8) Weekly trend (bar chart)
    destroyChart('weekly');
    const weekMap = {};
    rows.forEach(r => {
        const d = r.date;
        const dayOfWeek = d.getDay();
        const mondayOffset = (dayOfWeek === 0 ? -6 : 1 - dayOfWeek);
        const monday = new Date(d);
        monday.setDate(d.getDate() + mondayOffset);
        const key = fmtDate(monday);
        if (!weekMap[key]) weekMap[key] = { calls: 0, conv: 0 };
        weekMap[key].calls += r.calls;
        weekMap[key].conv += r.conv;
    });
    const weekKeys = Object.keys(weekMap).sort();
    charts.weekly = new Chart(makeCtx('chartWeekly'), {
        type: 'bar',
        data: {
            labels: weekKeys.map(k => k + '~'),
            datasets: [
                { label: 'ì½œ', data: weekKeys.map(k => weekMap[k].calls), backgroundColor: COLORS.calls + 'cc', borderRadius: 4 },
                { label: 'ì „í™˜', data: weekKeys.map(k => weekMap[k].conv), backgroundColor: COLORS.conv + 'cc', borderRadius: 4 }
            ]
        },
        options: {
            ...cloneDefaults(),
            responsive: true, maintainAspectRatio: false,
            plugins: { ...chartDefaults.plugins },
            scales: {
                x: { ticks: { color: '#64748b', font: { size: 10 }, maxRotation: 45 }, grid: { color: '#1e293b' } },
                y: { beginAtZero: true, ticks: { color: '#64748b' }, grid: { color: '#1e293b' } }
            }
        }
    });
}

/* â”€â”€â”€ Table â”€â”€â”€ */
function renderTable(rows) {
    const tbody = document.getElementById('tableBody');
    // Most recent first
    const sorted = [...rows].reverse();
    tbody.innerHTML = sorted.map(r => {
        const rate = r.calls > 0 ? (r.conv / r.calls * 100).toFixed(1) + '%' : '-';
        return `<tr>
            <td>${fmtDate(r.date)}</td>
            <td>${r.dayName}</td>
            <td>${fmtNum(r.sinGyu)}</td>
            <td>${fmtNum(r.calls)}</td>
            <td>${fmtNum(r.conv)}</td>
            <td>${rate}</td>
            <td>${fmtWon(r.convValue)}</td>
            <td>${fmtWon(r.m2Revenue)}</td>
        </tr>`;
    }).join('');
}

/* â”€â”€â”€ Events â”€â”€â”€ */
document.getElementById('periodSelect').addEventListener('change', render);

function refreshData() {
    fetchData();
}

/* â”€â”€â”€ Init â”€â”€â”€ */
fetchData();
setInterval(fetchData, 5 * 60 * 1000); // auto-refresh every 5 min
</script>
</body>
</html>
